{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">

  <!-- Back to post list -->
  <a href="{% url 'all posts' %}" class="inline-block mb-4 text-blue-600 hover:underline">
    ‚Üê Back to all posts
  </a>

  <!-- This container is the HTMX target -->
  <div id="post-detail-body">

    <!-- Post Title -->
    <h1 class="text-3xl font-bold mb-2">{{ post.title }}</h1>

    <!-- Metadata -->
    <p class="text-sm text-gray-600">
      By {{ post.author }} ‚Ä¢ {{ post.created_at|date:"M d, Y" }}
    </p>

    <!-- Post Image -->
    {% if post.image %}
      <img src="{{ post.image.url }}" class="my-4 rounded" alt="Post image">
    {% endif %}

    <!-- Post Content -->
    <div class="prose max-w-none">
      <p>{{ post.content|linebreaks }}</p>
    </div>

    <!-- Categories -->
    {% if post.categories.exists %}
      <div class="mt-4">
        <span class="font-semibold">Categories:</span>
        {% for cat in post.categories.all %}
          <span class="inline-block bg-gray-200 text-sm rounded px-2 py-1 mr-2">{{ cat.name }}</span>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Tags -->
    {% if post.tags.exists %}
      <div class="mt-2">
        <span class="font-semibold">Tags:</span>
        {% for tag in post.tags.all %}
          <span class="inline-block bg-blue-100 text-sm rounded px-2 py-1 mr-2">{{ tag.name }}</span>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Like Button -->
    {% include 'core/partials/like_button.html' %}

    <!-- Author Controls -->
    {% if user == post.author %}
      <div class="mt-6 space-x-4">
        <!-- HTMX Edit Button -->
        <button
          hx-get="{% url 'post edit partial' post.pk %}"
          hx-target="#post-detail-body"
          hx-swap="outerHTML"
          type="button"
          class="text-blue-600 hover:underline"
        >
          ‚úèÔ∏è Edit
        </button>

        <!-- Delete Button (Optional: confirm page) -->
        <a href="{% url 'delete post' post.pk %}" class="text-red-600 hover:underline">üóëÔ∏è Delete</a>
      </div>
    {% endif %}
  </div>

  <!-- COMMENTS SECTION -->
<div class="mt-8">
  <h3 class="text-xl font-semibold mb-4">Comments ({{ post.comments.count }})</h3>

  {% for comment in post.comments.all %}
    <div class="mb-4 p-3 border rounded">
      <p class="text-sm text-gray-600 mb-1">{{ comment.author.username }} ‚Ä¢ {{ comment.created_at|date:"M d, Y H:i" }}</p>
      <p class="text-gray-800">{{ comment.content }}</p>
    </div>
  {% empty %}
    <p class="text-gray-500">No comments yet.</p>
  {% endfor %}
</div>

<!-- COMMENT FORM -->
{% if user.is_authenticated %}
  <form method="POST" action="{% url 'add_comment' post.pk %}" class="mt-6">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      Post Comment
    </button>
  </form>
{% else %}
  <p class="text-gray-500 mt-6">
    <a href="{% url 'login' %}" class="text-blue-600 underline">Login</a> to post a comment.
  </p>
{% endif %}

</div>
{% endblock %}
